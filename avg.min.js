!function(t,n){function e(t,n){try{t.src&&(t.img=function(t){if(null==t)return null;try{let n=new Image;return n.src=t,n}catch(t){return null}}(t.src)),p[t.layer]=new function(t,n){this.img=t.img,this.layer=0,this.x,this.y,this.width,this.height,this.sx,this.sy,this.swidth,this.swidth,this.alpha,this.type="image",this.rotate,this.rotatePointX,this.rotatePointY;let e=this;null!=t.rotate?(this.rotate=t.rotate,this.rotatePointX=null!=t.rotatePointX?t.rotatePointX:null,this.rotatePointY=null!=t.rotatePointY?t.rotatePointY:null):(this.rotate=0,this.rotatePointX=0,this.rotatePointY=0),this.alpha=null==t.alpha?1:t.alpha,e.x=null==t.x?0:t.x,e.y=null==t.y?0:t.y,e.sx=null==t.sx?0:t.sx,e.sy=null==t.sx?0:t.sy,e.width=null==t.width?null!=t.img.width?t.img.width:0:t.width,e.height=null==t.height?null!=t.img.height?t.img.height:0:t.height,e.swidth=null==t.swidth?null!=t.img.width?t.img.width:0:t.swidth,e.sheight=null==t.sheight?null!=t.img.height?t.img.height:0:t.sheight;let i=0;t.img.width>0&&t.img.height>0&&(i=1,n()),this.img.onload=function(){e.width=null==t.width?e.img.width:t.width,e.height=null==t.height?e.img.height:t.height,e.swidth=null==t.swidth?e.img.width:t.swidth,e.sheight=null==t.sheight?e.img.height:t.sheight,0==i&&n()}}(t,n)}catch(t){console.log(t)}}function o(t,n){try{p[t.layer]=new function(t,n){this.type="text",this.text=t.text,this.font=null==t.font?g:t.font,this.color=null==t.color?y:t.color,this.x=t.x,this.y=t.y,null!=t.rotate?(this.rotate=t.rotate,this.rotatePointX=null!=t.rotatePointX?t.rotatePointX:null,this.rotatePointY=null!=t.rotatePointY?t.rotatePointY:null):(this.rotate=0,this.rotatePointX=0,this.rotatePointY=0),this.alpha=null==t.alpha?1:t.alpha,n()}(t,n)}catch(t){console.log(t)}}function l(t){let n=w.createElement("canvas");t.idName=null!=t.idName?t.idName:"avgMain",t.className=null!=t.className?t.className:"avgMain",t.realName=null!=t.realName?t.realName:"avgMain",n.setAttribute("id",null!=t.idName?t.idName:"avgMain"),n.setAttribute("class",null!=t.className?t.className:"avgCanvas"),d=null!=t.backgroundColor?t.backgroundColor:"#000",g=null!=t.defaultFont?t.defaultFont:'40px Arial,"Microsoft Yahei"',y=null!=t.defaultFontColor?t.defaultFontColor:"#FFF",n.setAttribute("name",t.realName?t.realName:"avgMain"),n.width=t.width,n.height=t.height,n.style.touchAction="none",w.body.insertBefore(n,w.body.lastChild),a=n,r=n.getContext("2d"),h=null!=t.volumeBGM?t.volumeBGM:.7,s=null!=t.volumeSE?t.volumeSE:.7,c=null!=t.volumeVoice?t.volumeVoice:.7,f=t.width,m=t.height,F=new A;let e,i=a;i.addEventListener("mousemove",function(n){e=i.getBoundingClientRect(),x=(n.clientX-e.left)*(t.width/e.width),P=(n.clientY-e.top)*(t.height/e.height)}),function(){let t=requestAnimationFrame(function n(){r.beginPath(),r.globalAlpha=1,r.fillStyle=d,r.fillRect(0,0,f,m);for(let t in p){let n=p[t];if(n&&"image"==n.type){if(r.globalAlpha=n.alpha,0!=n.rotate){let t=0,e=0;null==n.rotatePointX&&null==n.rotatePointY?(t=n.x,e=n.y):null==n.rotatePointX&&null==n.rotatePointY||(t=n.rotatePointX,e=n.rotatePointY),r.translate(t,e);let i=n.rotate*Math.PI/180;r.rotate(i),r.drawImage(n.img,n.sx,n.sy,n.swidth,n.sheight,n.x-t,n.y-e,n.width,n.height),r.rotate(-i),r.translate(-t,-e);continue}r.drawImage(n.img,n.sx,n.sy,n.swidth,n.sheight,n.x,n.y,n.width,n.height)}else if(n&&"text"==n.type){if(r.globalAlpha=n.alpha,r.fillStyle=n.color,r.font=n.font,0!=n.rotate){let t=0,e=0;null==n.rotatePointX&&null==n.rotatePointY?(t=n.x,e=n.y):null==n.rotatePointX&&null==n.rotatePointY||(t=n.rotatePointX,e=n.rotatePointY),r.translate(t,e);let i=n.rotate*Math.PI/180;r.rotate(i),r.fillText(n.text,n.x-t,n.y-e),r.rotate(-i),r.translate(-t,-e);continue}r.fillText(n.text,n.x,n.y)}}r.closePath(),t=requestAnimationFrame(n)})}(),console.log("avg.Js 已完成初始化")}let a,r,u,h,s,c,f,m,d,g,y,w=t.document,p=(t.navigator,t.location,new Array),v=new Array,x=0,P=0;new(t.AudioContext||t.webkitAudioContext);v.remove=(t=>{for(const n in v)if(v.hasOwnProperty(n)){if(v[n]===t)return void v.splice(n,1)}});class A{constructor(){this._queue=new Array,this.next()}add(t){this._queue.push(function(){return new Promise(n=>{t(n)})})}hasNext(){return this._queue.length>0}next(){const t=this;this._raf=requestAnimationFrame(async function n(){for(;t.hasNext();)await t._queue[0](),t._queue.splice(0,1);t.raf=requestAnimationFrame(n)})}stopQueue(){cancelAnimationFrame(this._raf)}}let F;t.avg={};let Y=t.avg;Y.creaveWindow=l,Y.loadImage=function(t){F.add(function(n){e(t,n)})},Y.loadText=function(t){F.add(function(n){o(t,n)})},Y.playBGM=function(t){F.add(function(n){!function(t,n){try{t.src?u?u.src=t.src:u=new Audio(t.src):(u&&u.pause(),u=t.audio),u.autoplay=!0,u.loop=!0,u.volume=h*(null==t.volume?1:t.volume),n(),4==u.readyState?u.play():u.oncanplay=function(){u.play()}}catch(t){console.log(t),n()}}(t,n)})},Y.stopBGM=function(t){F.add(function(n){!function(t={time:0},n){if(!u)return void n();let e,i,o=u.volume;n(),requestAnimationFrame(function n(l){e||(e=l),0==t.time&&(t.time=1),(i=1-(l-e)/t.time)<0&&(i=0),u.volume=o*i,i>0&&requestAnimationFrame(n)})}(t,n)})},Y.playSE=function(t){F.add(function(n){!function(t,n){try{let e;e=t.src?v.push(new Audio(t.src))-1:v.push(t.audio)-1,(e=v[e]).autoplay=!0,e.loop=!!t.loop,e.volume=s*(null==t.volume?1:t.volume),e.onended=function(){v.remove(e)},n(),4==e.readyState?e.play():e.oncanplay=function(){e.play()}}catch(t){console.log(t),n()}}(t,n)})},Y.setLayer=function(t){F.add(function(n){!function(t,n){t.layer&&t.from?(p[t.layer]=t.from,t.from.layer=t.layer,n()):n()}(t,n)})},Y.removeLayer=function(t){F.add(function(n){!function(t,n){if(!t.layer)return void n();const e=p[t.layer];p[t.layer]=null,t.fun&&t.fun(e),n()}(t,n)})},Y.removeAllLayer=function(){F.add(function(t){!function(t){for(i in p)p[i]=null;t()}(t)})},Y.move=function(t,n){F.add(function(e){!function(t,n=0,e){try{if(p[t.layer]){let i,o={},l=performance.now(),a=n,r={};for(let n in t)r[n]=p[t.layer][n],o[n]=p[t.layer][n],o[n]-=t[n],o[n]*=-1;if(0==n){for(let n in t)p[t.layer][n]=t[n];return void e()}o.layer=0;let u,h,s=t.layer,c=requestAnimationFrame(function t(){if(u<=0){for(let t in o)p[s][t]=o[t]+r[t];return cancelAnimationFrame(c),!0}i=performance.now(),(h=0==a?1:(i-l)/a)>1&&(h=1);for(let t in o)p[s][t]=h*o[t]+r[t];u=a-(i-l),h<1&&(c=requestAnimationFrame(t))});e()}}catch(t){console.log(t)}}(t,n,e)})},Y.wait=function(t){F.add(function(n){!function(t,n){let e=performance.now();(t-=13.34)<0&&(t=0);let i,o=requestAnimationFrame(function l(){(i=performance.now()-e)>=t?n():o=requestAnimationFrame(l)})}(t,n)})},Y.waitByFrame=function(t){F.add(function(n){!function(t,n){let e=t,i=requestAnimationFrame(function t(){--e<=0?n():i=requestAnimationFrame(t)})}(t,n)})},Y.setColor=function(t,n){F.add(function(e){p[t].color=n,e()})},Y.runFunction=function(t){F.add(function(n){!function(t,n){let e=!0;const i=F;F=new A;var o;try{t()}catch(t){console.log("catch Error"),o=t,t.info&&"BREAK_BY_AVG"===t.info?(t.plies--,t.plies<=0&&(e=!0,console.log("runFunction Broke"))):(console.log(t),console.log("runFunction runError"))}finally{if(F=i,e)n();else if(o)throw o}}(t,n)})},Y.break=function(t){!function(t=1){throw{plies:t,info:"BREAK_BY_AVG"}}(t)},Y.getLayerClientRect=function(t){const n=p[t];return n?{x:n.x,y:n.y,width:n.width,height:n.height}:null},Y.run=Y.runFunction,Y.getDOM=function(){return a},Y.mouse={x:new function(){this.toString=function(){return x}},y:new function(){this.toString=function(){return P}}}}(window);