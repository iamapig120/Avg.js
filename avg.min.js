class EventQueue{constructor(){this._queue=new Array}add(t){this._queue.push(function(e){t(e)}),this._flag||this.next()}hasNext(){return this._queue.length>0}next(){const t=this;this._flag=!0,async function(){for(;t.hasNext();)await new Promise(e=>{t._queue[0](e)}),t._queue.splice(0,1);t._flag=!1}()}clearQueue(){this._queue.splice(0,this._queue.length)}}class LoopQueue extends EventQueue{constructor(t=(()=>{})){super(),this._loopFun=t}next(){const t=this;this._flag=!0,async function(){for(;t.hasNext();)await new Promise(e=>{t._queue[0](e)}),t._queue.splice(0,1);t._flag=!1,t._loopFun()}()}setLoopFunction(t){if("function"!=typeof t)throw"Param is not a function!";_this._loopFun=t}clearQueue(){this._queue.splice(0,this._queue.length),_this._loopFun=(()=>{})}}class Layer{constructor({layer:t,x:e=0,y:n=0,alpha:i=1,rotate:o=0,rotatePointX:a=0,rotatePointY:r=0,dx:l=e,dy:s=n,rotatePointx:u=a,rotatePointy:h=r}={}){if("number"!=typeof t)throw"params must have 'layer:<number>'";this.layer=t,this.dx=l,this.dy=s,this.alpha=i,this.rotate=o,this.rotatePointx=u,this.rotatePointy=h,this.type}}class ImageLayer extends Layer{constructor({layer:t,sx:e,sy:n,swidth:i,sheight:o,x:a=0,y:r=0,width:l,height:s,alpha:u=1,rotate:h=0,rotatePointX:c=0,rotatePointY:f=0,sWidth:d=i,sHeight:m=o,dWidth:g=l,dHeight:y=s,dx:p=a,dy:_=r,rotatePointx:w=c,rotatePointy:v=f}={}){super(arguments[0])}}class Avg{constructor({target:t=document.createElement("canvas"),height:e=720,width:n=1280}={}){this._canvasMain,Object.defineProperty(this,"_canvasMain",{value:t,writable:!1}),this._canvasMask,Object.defineProperty(this,"_canvasMask",{value:document.createElement("canvas"),writable:!1}),this._eQ,Object.defineProperty(this,"_eQ",{value:this._nextEventQueue(),writable:!1}),this._paintBrush,Object.defineProperty(this,"_paintBrush",{value:this.getBrush(),writable:!1}),this._paintBrushForMask,Object.defineProperty(this,"_paintBrushForMask",{value:this.getBrush(!0),writable:!1}),this._layers,Object.defineProperty(this,"_layers",{value:new Array,writable:!1})}setSize({width:t=1280,height:e=720}={}){[this.getCanvas(),this.getCanvas(!0)].forEach(n=>{n.width=t,n.height=e})}getCanvas(t=!1){return t?this._canvasMain:this._canvasMask}getBrush(t=!1){return(t?this._canvasMain:this._canvasMask).getContext("2d")}wait(t){this._eQ.add(e=>{let n=performance.now();(t-=13.34)<0&&(t=0);let i,o=requestAnimationFrame(function a(){(i=performance.now()-n)>=t?e():o=requestAnimationFrame(a)})})}sleep(t){this.wait(t)}runFunction(t){this._eQ.add(async e=>{var n,i=!1;try{await t()}catch(t){n=t,t.info&&"BREAK_BY_AVG"===t.info?(t.plies--,t.plies<=0&&(i=!0,console.log("runFunction Broke"))):(console.log(t),console.log("runFunction runError"))}finally{if(e(),!i&&n)throw n}})}run(t){this.runFunction(t)}_nextEventQueue(t="eventQueue",e=(()=>{})){if(this._eQPointer,this._eQArray,void 0!==this._eQPointer&&this._eQArray||(this._eQPointer=-1,this._eQArray=new Array),this._eQPointer++,!this._eQArray[this._eQPointer])switch(t){case"eventQueue":this._eQArray[this._eQPointer]=new EventQueue;break;case"loopQueue":this._eQArray[this._eQPointer]=new LoopQueue}return this._eQArray[this._eQPointer].clearQueue(),this._eQArray[this._eQPointer].__proto__.constructor===LoopQueue&&this._eQArray[this._eQPointer].setLoopFunction(e),this._eQArray[this._eQPointer]}_lastEventQueue(){if(void 0===this._eQPointer||!this._eQArray)throw"No Queque in Array!";return this._eQPointer--,this._eQPointer<0&&(this._eQPointer=0),this._eQArray[this._eQPointer]}}!function(t,e){function n(t="eventQueue",e){if(E++,!B[E])switch(t){case"eventQueue":B[E]=new q;break;case"loopQueue":B[E]=new b}return e&&B[E].__proto__.constructor===b&&(B[E]._loopFun=e),B[E]}function o(t,e){try{t.src&&(t.img=function(t){if(null==t)return null;try{let e=new Image;return e.src=t,e}catch(t){return null}}(t.src)),x[t.layer]=new function(t,e){this.img=t.img,this.layer=0,this.x,this.y,this.width,this.height,this.sx,this.sy,this.swidth,this.swidth,this.alpha,this.type="image",this.rotate,this.rotatePointX,this.rotatePointY,this.mask=!!t.mask&&t.mask;const n=this;null!=t.rotate?(this.rotate=t.rotate,this.rotatePointX=null!=t.rotatePointX?t.rotatePointX:null,this.rotatePointY=null!=t.rotatePointY?t.rotatePointY:null):(this.rotate=0,this.rotatePointX=0,this.rotatePointY=0),this.alpha=null==t.alpha?1:t.alpha,n.x=null==t.x?0:t.x,n.y=null==t.y?0:t.y,n.sx=null==t.sx?0:t.sx,n.sy=null==t.sx?0:t.sy,n.width=null==t.width?null!=t.img.width?t.img.width:0:t.width,n.height=null==t.height?null!=t.img.height?t.img.height:0:t.height,n.swidth=null==t.swidth?null!=t.img.width?t.img.width:0:t.swidth,n.sheight=null==t.sheight?null!=t.img.height?t.img.height:0:t.sheight;let i=0;t.img.width>0&&t.img.height>0&&(i=1,e()),this.img.addEventListener("load",o=>{n.width=null==t.width?n.img.width:t.width,n.height=null==t.height?n.img.height:t.height,n.swidth=null==t.swidth?n.img.width:t.swidth,n.sheight=null==t.sheight?n.img.height:t.sheight,0==i&&e()})}(t,e)}catch(t){console.log(t)}}function a(t,e){try{x[t.layer]=new function(t,e){this.type="text",this.text=t.text,this.font=null==t.font?w:t.font,this.color=null==t.color?v:t.color,this.x=t.x,this.y=t.y,null!=t.rotate?(this.rotate=t.rotate,this.rotatePointX=null!=t.rotatePointX?t.rotatePointX:null,this.rotatePointY=null!=t.rotatePointY?t.rotatePointY:null):(this.rotate=0,this.rotatePointX=0,this.rotatePointY=0),this.mask=!!t.mask&&t.mask,this.alpha=null==t.alpha?1:t.alpha,e()}(t,e)}catch(t){console.log(t)}}function r(e){let i=P.createElement("canvas");e.idName=null!=e.idName?e.idName:"avgMain",e.className=null!=e.className?e.className:"avgMain",e.realName=null!=e.realName?e.realName:"avgMain",i.setAttribute("id",null!=e.idName?e.idName:"avgMain"),i.setAttribute("class",null!=e.className?e.className:"avgCanvas"),_=null!=e.backgroundColor?e.backgroundColor:"#000",w=null!=e.defaultFont?e.defaultFont:'40px Arial,"Microsoft Yahei"',v=null!=e.defaultFontColor?e.defaultFontColor:"#FFF",i.setAttribute("name",e.realName?e.realName:"avgMain"),i.width=e.width,i.height=e.height,i.style.touchAction="none",P.body.insertBefore(i,P.body.lastChild),s=i,h=i.getContext("2d"),(u=P.createElement("canvas")).width=e.width,u.height=e.height,c=u.getContext("2d"),d=null!=e.volumeBGM?e.volumeBGM:.7,m=null!=e.volumeSE?e.volumeSE:.7,g=null!=e.volumeVoice?e.volumeVoice:.7,y=e.width,p=e.height,k=n();let o,a=s;if(a.addEventListener("mousemove",function(t){o=a.getBoundingClientRect(),Q=(t.clientX-o.left)*(e.width/o.width),F=(t.clientY-o.top)*(e.height/o.height)}),"ontouchstart"in t){function r(t){t.preventDefault(),t=t.touches[0],o=a.getBoundingClientRect(),Q=(t.clientX-o.left)*(e.width/o.width),F=(t.clientY-o.top)*(e.height/o.height)}a.addEventListener("touchmove",r),a.addEventListener("touchstart",r)}!function(){h.globalCompositeOperation="destination-over";let t,e=!1;requestAnimationFrame(function n(){h.beginPath(),h.clearRect(0,0,y,p);for(var i=x.length-1;i>=0;i--)if(x[i]){const n=x[i];if(n.mask&&!e?(e=n.mask,c.globalCompositeOperation="destination-over",t=h,h=c):"shade"==e?c.globalCompositeOperation="source-in":"mask"!=e||n.mask||(c.globalCompositeOperation="destination-atop"),"image"==n.type){if(h.globalAlpha=n.alpha,0!=n.rotate){h.save();let t=0,e=0;null==n.rotatePointX&&null==n.rotatePointY?(t=n.x,e=n.y):null==n.rotatePointX&&null==n.rotatePointY||(t=n.rotatePointX,e=n.rotatePointY),h.translate(t,e);let i=n.rotate*Math.PI/180;h.rotate(i),h.drawImage(n.img,n.sx,n.sy,n.swidth,n.sheight,n.x-t,n.y-e,n.width,n.height),h.restore();continue}h.drawImage(n.img,n.sx,n.sy,n.swidth,n.sheight,n.x,n.y,n.width,n.height)}else if("text"==n.type){if(h.globalAlpha=n.alpha,h.fillStyle=n.color,h.font=n.font,0!=n.rotate){h.save();let t=0,e=0;null==n.rotatePointX&&null==n.rotatePointY?(t=n.x,e=n.y):null==n.rotatePointX&&null==n.rotatePointY||(t=n.rotatePointX,e=n.rotatePointY),h.translate(t,e);let i=n.rotate*Math.PI/180;h.rotate(i),h.fillText(n.text,n.x-t,n.y-e),h.restore();continue}h.fillText(n.text,n.x,n.y)}e&&!n.mask&&(e=!1,(h=t).drawImage(u,0,0),c.clearRect(0,0,y,p))}h.globalAlpha=1,h.fillStyle=_,h.fillRect(0,0,y,p),h.closePath(),requestAnimationFrame(n)})}(),console.log("avg.Js 已完成初始化")}function l(t,e){var i,o=!1;try{k=n("loopQueue",t),t()}catch(t){if(i=t,t.info&&"BREAK_BY_AVG"===t.info){if(t.plies--,t.plies<=0&&(o=!0,console.log("loopFunction Broke")),k.clearQueue(),--E<0&&(E=0),k=B[E],e(),!o&&i)throw i}else console.log(t),console.log("runFunction runError");e()}}let s,u,h,c,f,d,m,g,y,p,_,w,v,P=t.document,x=(t.navigator,t.location,new Array),A=new Array,Q=0,F=0;new(t.AudioContext||t.webkitAudioContext);A.remove=(t=>{for(const e in A)if(A.hasOwnProperty(e)){if(A[e]===t)return void A.splice(e,1)}});class q{constructor(){this._queue=new Array}add(t){this._queue.push(function(e){t(e)}),this._flag||this.next()}hasNext(){return this._queue.length>0}next(){const t=this;this._flag=!0,async function(){for(;t.hasNext();)await new Promise(e=>{t._queue[0](e)}),t._queue.splice(0,1);t._flag=!1}()}clearQueue(){this._queue.splice(0,this._queue.length)}}class b{constructor(t=(()=>{})){this._queue=new Array,this._loopFun=t}add(t){this._queue.push(function(e){t(e)}),this._flag||this.next()}hasNext(){return this._queue.length>0}next(){const t=this;this._flag=!0,async function(){for(;t.hasNext();)await new Promise(e=>{t._queue[0](e)}),t._queue.splice(0,1);t._flag=!1,t._loopFun()}()}clearQueue(){this._queue.splice(0,this._queue.length)}}let k;const B=new Array;let E=-1;t.avg={};let Y=t.avg;Y.creaveWindow=r,Y.loadImage=function(t){k.add(function(e){o(t,e)})},Y.loadText=function(t){k.add(function(e){a(t,e)})},Y.playBGM=function(t){k.add(function(e){!function(t,e){try{t.src?f?f.src=t.src:f=new Audio(t.src):(f&&f.pause(),f=t.audio),f.autoplay=!0,f.loop=!0,f.volume=d*(null==t.volume?1:t.volume),e(),4==f.readyState?(f.play(),f.currentTime>0&&(f.currentTime=0)):f.oncanplay=function(){f.play(),f.currentTime>0&&(f.currentTime=0)}}catch(t){console.log(t),e()}}(t,e)})},Y.stopBGM=function(t){k.add(function(e){!function(t={time:0},e){if(!f)return void e();let n,i,o=f.volume;e(),requestAnimationFrame(function e(a){n||(n=a),0==t.time&&(t.time=1),(i=1-(a-n)/t.time)<0&&(i=0),f.volume=o*i,i>0&&requestAnimationFrame(e)})}(t,e)})},Y.playSE=function(t){k.add(function(e){!function(t,e){try{let n;n=t.src?A.push(new Audio(t.src))-1:A.push(t.audio)-1,(n=A[n]).autoplay=!0,n.loop=!!t.loop,n.volume=m*(null==t.volume?1:t.volume),n.onended=function(){A.remove(n)},e(),4==n.readyState?(n.play(),n.currentTime>0&&(n.currentTime=0)):n.oncanplay=function(){n.play(),n.currentTime>0&&(n.currentTime=0)}}catch(t){console.log(t),e()}}(t,e)})},Y.setLayer=function(t){k.add(function(e){!function(t,e){t.layer&&t.from?(x[t.layer]=t.from,t.from.layer=t.layer,e()):e()}(t,e)})},Y.removeLayer=function(t){k.add(function(e){!function(t,e){if(!t.layer)return void e();const n=x[t.layer];x[t.layer]=null,t.fun&&t.fun(n),e()}(t,e)})},Y.removeAllLayer=function(){k.add(function(t){!function(t){for(i in x)x[i]=null;t()}(t)})},Y.move=function(t,e){k.add(function(n){!function(t,e=0,n){try{if(x[t.layer]){let i,o={},a=performance.now(),r=e,l={};for(let e in t)l[e]=x[t.layer][e],o[e]=x[t.layer][e],o[e]-=t[e],o[e]*=-1;if(0==e){for(let e in t)x[t.layer][e]=t[e];return void n()}o.layer=0;let s,u,h=t.layer,c=requestAnimationFrame(function t(){if(s<=0){for(let t in o)x[h][t]=o[t]+l[t];return cancelAnimationFrame(c),!0}i=performance.now(),(u=0==r?1:(i-a)/r)>1&&(u=1);for(let t in o)x[h][t]=u*o[t]+l[t];s=r-(i-a),u<1&&(c=requestAnimationFrame(t))});n()}}catch(t){console.log(t)}}(t,e,n)})},Y.wait=function(t){k.add(function(e){!function(t,e){let n=performance.now();(t-=13.34)<0&&(t=0);let i,o=requestAnimationFrame(function a(){(i=performance.now()-n)>=t?e():o=requestAnimationFrame(a)})}(t,e)})},Y.waitByFrame=function(t){k.add(function(e){!function(t,e){let n=t,i=requestAnimationFrame(function t(){--n<=0?e():i=requestAnimationFrame(t)})}(t,e)})},Y.setColor=function(t,e){k.add(function(n){x[t].color=e,n()})},Y.runFunction=function(t){k.add(function(e){!function(t,e){var n,i=!1;try{t()}catch(t){n=t,t.info&&"BREAK_BY_AVG"===t.info?(t.plies--,t.plies<=0&&(i=!0,console.log("runFunction Broke"))):(console.log(t),console.log("runFunction runError"))}finally{if(e(),!i&&n)throw n}}(t,e)})},Y.loopFunction=function(t){k.add(function(e){l(t,e)})},Y.break=function(t){!function(t=1){throw{plies:t,info:"BREAK_BY_AVG"}}(t)},Y.getLayerClientRect=function(t){const e=x[t];return e?{x:e.x,y:e.y,width:e.width,height:e.height}:null},Y.run=Y.runFunction,Y.loop=Y.loopFunction,Y.getDOM=function(){return s},Y.mouse={get x(){return Q},get y(){return F}},t.theLayer=x}(window);