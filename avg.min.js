const LAYER_TYPE_IMAGE="image",LAYER_TYPE_TEXT="text",switchInstanceof=(t,e)=>{e.forEach(e=>{t instanceof e[0]&&e[1](t)})};class EventQueue{constructor(){this._queue=new Array}add(t){this._queue.push(function(e){t(e)}),this._flag||this.next()}hasNext(){return this._queue.length>0}next(){const t=this;this._flag=!0,async function(){for(;t.hasNext();)await new Promise(e=>{t._queue[0](e)}),t._queue.splice(0,1);t._flag=!1}()}clearQueue(){this._queue.splice(0,this._queue.length),this._flag=!1}}class LoopQueue extends EventQueue{constructor(t=(()=>{}),e=(()=>new Promise(t=>t()))){super(),this._loopFun=t,this._resFun=e}next(){const t=this;this._flag=!0,async function(){for(;t.hasNext();)await new Promise(e=>{t._queue[0](e)}),t._queue.splice(0,1);t._flag=!1,t._loopFun()}()}setLoopFunction(t){if("function"!=typeof t)throw"Param is not a function!";this._loopFun=t}setResloveFunction(t){this._resFun=t}clearQueue(){this._queue.splice(0,this._queue.length),this._flag=!1,this._loopFun=(()=>{}),this._resFun()}}class Layer{constructor({layer:t,x:e=0,y:i=0,alpha:n=1,rotate:o=0,rotatePointX:a=0,rotatePointY:s=0,dx:r=e,dy:h=i,rotatePointx:l=a,rotatePointy:u=s,mask:c=!1}={}){if("number"!=typeof t)throw"params must have 'layer:<number>'";this.layer=t,this.dx=r,this.dy=h,this.alpha=n,this.rotate=o,this.rotatePointx=l,this.rotatePointy=u,this.mask=c,this.type}}class ImageLayer extends Layer{constructor({layer:t,sx:e=0,sy:i=0,swidth:n,sheight:o,x:a=0,y:s=0,width:r,height:h,alpha:l=1,rotate:u=0,rotatePointX:c=0,rotatePointY:d=0,sWidth:f=n,sHeight:m=o,dWidth:g=r,dHeight:y=h,dx:p=a,dy:_=s,rotatePointx:w=c,rotatePointy:v=d,mask:P=!1,src:x,img:Q=new Image}={}){super(arguments[0]),this.type="image",this.img=Q,this.sx=e,this.sy=i;const A=t=>"number"==typeof t;A(g)&&(this.dWidth=g),A(y)&&(this.dHeight=y),A(f)&&(this.sWidth=f),A(m)&&(this.sHeight=m),switchInstanceof(this.img,[[HTMLImageElement,t=>{const e=()=>{A(this.dWidth)||(this.dWidth=t.naturalWidth),A(this.dHeight)||(this.dHeight=t.naturalHeight),A(this.sWidth)||(this.sWidth=t.naturalWidth),A(this.sHeight)||(this.sHeight=t.naturalHeight)};if(x&&(this.img.src=x),this.img.complete)e();else{const t=()=>{e(),this.img.removeEventListener("load",t)};this.img.addEventListener("load",t)}}],[HTMLCanvasElement,t=>{(()=>{A(this.dWidth)||(this.dWidth=t.width),A(this.dHeight)||(this.dHeight=t.height),A(this.sWidth)||(this.sWidth=t.width),A(this.sHeight)||(this.sHeight=t.height)})()}]])}}class Avg{constructor({target:t=document.createElement("canvas"),height:e=720,width:i=1280}={}){this._canvasMain,Object.defineProperty(this,"_canvasMain",{value:t,writable:!1}),this._canvasMask,Object.defineProperty(this,"_canvasMask",{value:document.createElement("canvas"),writable:!1}),this._eQ=this._nextEventQueue(),this._paintBrush,Object.defineProperty(this,"_paintBrush",{value:this.getBrush(),writable:!1}),this._paintBrushForMask,Object.defineProperty(this,"_paintBrushForMask",{value:this.getBrush(!0),writable:!1}),this._layers,Object.defineProperty(this,"_layers",{value:new Array,writable:!1}),this._loopPliesCount=0}setSize({width:t=1280,height:e=720}={}){[this.getCanvas(),this.getCanvas(!0)].forEach(i=>{i.width=t,i.height=e})}getCanvas(t=!1){return t?this._canvasMain:this._canvasMask}getBrush(t=!1){return(t?this._canvasMain:this._canvasMask).getContext("2d")}wait(t){this._eQ.add(e=>{let i=performance.now();(t-=13.34)<0&&(t=0);let n,o=requestAnimationFrame(function a(){(n=performance.now()-i)>=t?e():o=requestAnimationFrame(a)})})}sleep(t){this.wait(t)}runFunction(t){this._eQ.add(async e=>{try{await t()}catch(t){if(!t.info||"BREAK_BY_AVG"!==t.info)throw console.log("runFunction runError"),t;if(!(t.plies<=this._loopPliesCount))throw"break loops' param too large";this._loopPliesCount-=t.plies;for(let e=0;e<t.plies;e++)this._eQ.clearQueue(),this._eQ=this._lastEventQueue()}finally{e()}})}run(t){this.runFunction(t)}loopFunction(t){this._eQ.add(async e=>{this._loopPliesCount++,this._eQ=this._nextEventQueue("loopQueue",()=>{this.runFunction(t)},e),this.runFunction(t)})}loop(t){this.loopFunction(t)}breakLoopFunction(t=1){if("number"!=typeof t)throw"can not break function by a wrong plies";throw{plies:t,info:"BREAK_BY_AVG"}}break(t=1){this.breakLoopFunction(t)}_nextEventQueue(t="eventQueue",e=(()=>{}),i=(()=>new Promise(t=>t()))){if(this._eQPointer,this._eQArray,void 0!==this._eQPointer&&this._eQArray||(this._eQPointer=-1,this._eQArray=new Array),this._eQPointer++,!this._eQArray[this._eQPointer])switch(t){case"eventQueue":this._eQArray[this._eQPointer]=new EventQueue;break;case"loopQueue":this._eQArray[this._eQPointer]=new LoopQueue}return this._eQArray[this._eQPointer].__proto__.constructor===LoopQueue&&(this._eQArray[this._eQPointer].setLoopFunction(e),this._eQArray[this._eQPointer].setResloveFunction(i)),this._eQArray[this._eQPointer]}_lastEventQueue(){if(void 0===this._eQPointer||!this._eQArray)throw"No Queque in Array!";return this._eQPointer--,this._eQPointer<0&&(this._eQPointer=0),this._eQArray[this._eQPointer]}}!function(t,e){function n(t="eventQueue",e){if(Y++,!k[Y])switch(t){case"eventQueue":k[Y]=new b;break;case"loopQueue":k[Y]=new q}return e&&k[Y].__proto__.constructor===q&&(k[Y]._loopFun=e),k[Y]}function o(t,e){try{t.src&&(t.img=function(t){if(null==t)return null;try{let e=new Image;return e.src=t,e}catch(t){return null}}(t.src)),x[t.layer]=new function(t,e){this.img=t.img,this.layer=0,this.x,this.y,this.width,this.height,this.sx,this.sy,this.swidth,this.swidth,this.alpha,this.type="image",this.rotate,this.rotatePointX,this.rotatePointY,this.mask=!!t.mask&&t.mask;const i=this;null!=t.rotate?(this.rotate=t.rotate,this.rotatePointX=null!=t.rotatePointX?t.rotatePointX:null,this.rotatePointY=null!=t.rotatePointY?t.rotatePointY:null):(this.rotate=0,this.rotatePointX=0,this.rotatePointY=0),this.alpha=null==t.alpha?1:t.alpha,i.x=null==t.x?0:t.x,i.y=null==t.y?0:t.y,i.sx=null==t.sx?0:t.sx,i.sy=null==t.sx?0:t.sy,i.width=null==t.width?null!=t.img.width?t.img.width:0:t.width,i.height=null==t.height?null!=t.img.height?t.img.height:0:t.height,i.swidth=null==t.swidth?null!=t.img.width?t.img.width:0:t.swidth,i.sheight=null==t.sheight?null!=t.img.height?t.img.height:0:t.sheight;let n=0;t.img.width>0&&t.img.height>0&&(n=1,e()),this.img.addEventListener("load",o=>{i.width=null==t.width?i.img.width:t.width,i.height=null==t.height?i.img.height:t.height,i.swidth=null==t.swidth?i.img.width:t.swidth,i.sheight=null==t.sheight?i.img.height:t.sheight,0==n&&e()})}(t,e)}catch(t){console.log(t)}}function a(t,e){try{x[t.layer]=new function(t,e){this.type="text",this.text=t.text,this.font=null==t.font?w:t.font,this.color=null==t.color?v:t.color,this.x=t.x,this.y=t.y,null!=t.rotate?(this.rotate=t.rotate,this.rotatePointX=null!=t.rotatePointX?t.rotatePointX:null,this.rotatePointY=null!=t.rotatePointY?t.rotatePointY:null):(this.rotate=0,this.rotatePointX=0,this.rotatePointY=0),this.mask=!!t.mask&&t.mask,this.alpha=null==t.alpha?1:t.alpha,e()}(t,e)}catch(t){console.log(t)}}function s(e){let i=P.createElement("canvas");e.idName=null!=e.idName?e.idName:"avgMain",e.className=null!=e.className?e.className:"avgMain",e.realName=null!=e.realName?e.realName:"avgMain",i.setAttribute("id",null!=e.idName?e.idName:"avgMain"),i.setAttribute("class",null!=e.className?e.className:"avgCanvas"),_=null!=e.backgroundColor?e.backgroundColor:"#000",w=null!=e.defaultFont?e.defaultFont:'40px Arial,"Microsoft Yahei"',v=null!=e.defaultFontColor?e.defaultFontColor:"#FFF",i.setAttribute("name",e.realName?e.realName:"avgMain"),i.width=e.width,i.height=e.height,i.style.touchAction="none",P.body.insertBefore(i,P.body.lastChild),h=i,u=i.getContext("2d"),(l=P.createElement("canvas")).width=e.width,l.height=e.height,c=l.getContext("2d"),f=null!=e.volumeBGM?e.volumeBGM:.7,m=null!=e.volumeSE?e.volumeSE:.7,g=null!=e.volumeVoice?e.volumeVoice:.7,y=e.width,p=e.height,E=n();let o,a=h;if(a.addEventListener("mousemove",function(t){o=a.getBoundingClientRect(),A=(t.clientX-o.left)*(e.width/o.width),F=(t.clientY-o.top)*(e.height/o.height)}),"ontouchstart"in t){function s(t){t.preventDefault(),t=t.touches[0],o=a.getBoundingClientRect(),A=(t.clientX-o.left)*(e.width/o.width),F=(t.clientY-o.top)*(e.height/o.height)}a.addEventListener("touchmove",s),a.addEventListener("touchstart",s)}!function(){u.globalCompositeOperation="destination-over";let t,e=!1;requestAnimationFrame(function i(){u.beginPath(),u.clearRect(0,0,y,p);for(var n=x.length-1;n>=0;n--)if(x[n]){const i=x[n];if(i.mask&&!e?(e=i.mask,c.globalCompositeOperation="destination-over",t=u,u=c):"shade"==e?c.globalCompositeOperation="source-in":"mask"!=e||i.mask||(c.globalCompositeOperation="destination-atop"),"image"==i.type){if(u.globalAlpha=i.alpha,0!=i.rotate){u.save();let t=0,e=0;null==i.rotatePointX&&null==i.rotatePointY?(t=i.x,e=i.y):null==i.rotatePointX&&null==i.rotatePointY||(t=i.rotatePointX,e=i.rotatePointY),u.translate(t,e);let n=i.rotate*Math.PI/180;u.rotate(n),u.drawImage(i.img,i.sx,i.sy,i.swidth,i.sheight,i.x-t,i.y-e,i.width,i.height),u.restore();continue}u.drawImage(i.img,i.sx,i.sy,i.swidth,i.sheight,i.x,i.y,i.width,i.height)}else if("text"==i.type){if(u.globalAlpha=i.alpha,u.fillStyle=i.color,u.font=i.font,0!=i.rotate){u.save();let t=0,e=0;null==i.rotatePointX&&null==i.rotatePointY?(t=i.x,e=i.y):null==i.rotatePointX&&null==i.rotatePointY||(t=i.rotatePointX,e=i.rotatePointY),u.translate(t,e);let n=i.rotate*Math.PI/180;u.rotate(n),u.fillText(i.text,i.x-t,i.y-e),u.restore();continue}u.fillText(i.text,i.x,i.y)}e&&!i.mask&&(e=!1,(u=t).drawImage(l,0,0),c.clearRect(0,0,y,p))}u.globalAlpha=1,u.fillStyle=_,u.fillRect(0,0,y,p),u.closePath(),requestAnimationFrame(i)})}(),console.log("avg.Js 已完成初始化")}function r(t,e){var i,n=!1;try{t()}catch(t){i=t,t.info&&"BREAK_BY_AVG"===t.info?(t.plies-=1,t.plies<=0&&(n=!0,--Y<0&&(Y=0),E=k[Y],console.log("runFunction Broke"))):console.log("runFunction runError")}finally{if(e(),!n&&i)throw i}}let h,l,u,c,d,f,m,g,y,p,_,w,v,P=t.document,x=(t.navigator,t.location,new Array),Q=new Array,A=0,F=0;new(t.AudioContext||t.webkitAudioContext);Q.remove=(t=>{for(const e in Q)if(Q.hasOwnProperty(e)){if(Q[e]===t)return void Q.splice(e,1)}});class b{constructor(){this._queue=new Array}add(t){this._queue.push(function(e){t(e)}),this._flag||this.next()}hasNext(){return this._queue.length>0}next(){const t=this;this._flag=!0,async function(){for(;t.hasNext();)await new Promise(e=>{t._queue[0](e)}),t._queue.splice(0,1);t._flag=!1}()}clearQueue(){this._queue.splice(0,this._queue.length)}}class q{constructor(t=(()=>{})){this._queue=new Array,this._loopFun=t}add(t){this._queue.push(function(e){t(e)}),this._flag||this.next()}hasNext(){return this._queue.length>0}next(){const t=this;this._flag=!0,async function(){for(;t.hasNext();)await new Promise(e=>{t._queue[0](e)}),t._queue.splice(0,1);t._flag=!1,avg.run(()=>t._loopFun())}()}clearQueue(){this._queue.splice(0,this._queue.length),_this._loopFun=(()=>{})}}let E;const k=new Array;let Y=-1;t.avg={};let C=t.avg;C.creaveWindow=s,C.loadImage=function(t){E.add(function(e){o(t,e)})},C.loadText=function(t){E.add(function(e){a(t,e)})},C.playBGM=function(t){E.add(function(e){!function(t,e){try{t.src?d?d.src=t.src:d=new Audio(t.src):(d&&d.pause(),d=t.audio),d.autoplay=!0,d.loop=!0,d.volume=f*(null==t.volume?1:t.volume),e(),4==d.readyState?(d.play(),d.currentTime>0&&(d.currentTime=0)):d.oncanplay=function(){d.play(),d.currentTime>0&&(d.currentTime=0)}}catch(t){console.log(t),e()}}(t,e)})},C.stopBGM=function(t){E.add(function(e){!function(t={time:0},e){if(!d)return void e();let i,n,o=d.volume;e(),requestAnimationFrame(function e(a){i||(i=a),0==t.time&&(t.time=1),(n=1-(a-i)/t.time)<0&&(n=0),d.volume=o*n,n>0&&requestAnimationFrame(e)})}(t,e)})},C.playSE=function(t){E.add(function(e){!function(t,e){try{let i;i=t.src?Q.push(new Audio(t.src))-1:Q.push(t.audio)-1,(i=Q[i]).autoplay=!0,i.loop=!!t.loop,i.volume=m*(null==t.volume?1:t.volume),i.onended=function(){Q.remove(i)},e(),4==i.readyState?(i.play(),i.currentTime>0&&(i.currentTime=0)):i.oncanplay=function(){i.play(),i.currentTime>0&&(i.currentTime=0)}}catch(t){console.log(t),e()}}(t,e)})},C.setLayer=function(t){E.add(function(e){!function(t,e){t.layer&&t.from?(x[t.layer]=t.from,t.from.layer=t.layer,e()):e()}(t,e)})},C.removeLayer=function(t){E.add(function(e){!function(t,e){if(!t.layer)return void e();const i=x[t.layer];x[t.layer]=null,t.fun&&t.fun(i),e()}(t,e)})},C.removeAllLayer=function(){E.add(function(t){!function(t){for(i in x)x[i]=null;t()}(t)})},C.move=function(t,e){E.add(function(i){!function(t,e=0,i){try{if(x[t.layer]){let n,o={},a=performance.now(),s=e,r={};for(let e in t)r[e]=x[t.layer][e],o[e]=x[t.layer][e],o[e]-=t[e],o[e]*=-1;if(0==e){for(let e in t)x[t.layer][e]=t[e];return void i()}o.layer=0;let h,l,u=t.layer,c=requestAnimationFrame(function t(){if(h<=0){for(let t in o)x[u][t]=o[t]+r[t];return cancelAnimationFrame(c),!0}n=performance.now(),(l=0==s?1:(n-a)/s)>1&&(l=1);for(let t in o)x[u][t]=l*o[t]+r[t];h=s-(n-a),l<1&&(c=requestAnimationFrame(t))});i()}}catch(t){console.log(t)}}(t,e,i)})},C.wait=function(t){E.add(function(e){!function(t,e){let i=performance.now();(t-=13.34)<0&&(t=0);let n,o=requestAnimationFrame(function a(){(n=performance.now()-i)>=t?e():o=requestAnimationFrame(a)})}(t,e)})},C.waitByFrame=function(t){E.add(function(e){!function(t,e){let i=t,n=requestAnimationFrame(function t(){--i<=0?e():n=requestAnimationFrame(t)})}(t,e)})},C.setColor=function(t,e){E.add(function(i){x[t].color=e,i()})},C.runFunction=function(t){E.add(function(e){r(t,e)})},C.loopFunction=function(t){E.add(function(e){!function(t,e){var i=this;E=n("loopQueue",()=>{t.call(i)}),t.call(i)}(t)})},C.break=function(t){!function(t=1){throw{plies:t,info:"BREAK_BY_AVG"}}(t)},C.getLayerClientRect=function(t){const e=x[t];return e?{x:e.x,y:e.y,width:e.width,height:e.height}:null},C.run=C.runFunction,C.loop=C.loopFunction,C.getDOM=function(){return h},C.mouse={get x(){return A},get y(){return F}},t.theLayer=x}(window);