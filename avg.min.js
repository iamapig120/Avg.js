!function(t,e){function n(t,e){try{t.src&&(t.img=function(t){if(null==t)return null;try{let e=new Image;return e.src=t,e}catch(t){return null}}(t.src)),x[t.layer]=new function(t,e){this.img=t.img,this.layer=0,this.x,this.y,this.width,this.height,this.sx,this.sy,this.swidth,this.swidth,this.alpha,this.type="image",this.rotate,this.rotatePointX,this.rotatePointY,this.mask=!!t.mask&&t.mask;const n=this;null!=t.rotate?(this.rotate=t.rotate,this.rotatePointX=null!=t.rotatePointX?t.rotatePointX:null,this.rotatePointY=null!=t.rotatePointY?t.rotatePointY:null):(this.rotate=0,this.rotatePointX=0,this.rotatePointY=0),this.alpha=null==t.alpha?1:t.alpha,n.x=null==t.x?0:t.x,n.y=null==t.y?0:t.y,n.sx=null==t.sx?0:t.sx,n.sy=null==t.sx?0:t.sy,n.width=null==t.width?null!=t.img.width?t.img.width:0:t.width,n.height=null==t.height?null!=t.img.height?t.img.height:0:t.height,n.swidth=null==t.swidth?null!=t.img.width?t.img.width:0:t.swidth,n.sheight=null==t.sheight?null!=t.img.height?t.img.height:0:t.sheight;let i=0;t.img.width>0&&t.img.height>0&&(i=1,e()),this.img.onload=function(){n.width=null==t.width?n.img.width:t.width,n.height=null==t.height?n.img.height:t.height,n.swidth=null==t.swidth?n.img.width:t.swidth,n.sheight=null==t.sheight?n.img.height:t.sheight,0==i&&e()}}(t,e)}catch(t){console.log(t)}}function o(t,e){try{x[t.layer]=new function(t,e){this.type="text",this.text=t.text,this.font=null==t.font?w:t.font,this.color=null==t.color?p:t.color,this.x=t.x,this.y=t.y,null!=t.rotate?(this.rotate=t.rotate,this.rotatePointX=null!=t.rotatePointX?t.rotatePointX:null,this.rotatePointY=null!=t.rotatePointY?t.rotatePointY:null):(this.rotate=0,this.rotatePointX=0,this.rotatePointY=0),this.mask=!!t.mask&&t.mask,this.alpha=null==t.alpha?1:t.alpha,e()}(t,e)}catch(t){console.log(t)}}function l(t){let e=v.createElement("canvas");t.idName=null!=t.idName?t.idName:"avgMain",t.className=null!=t.className?t.className:"avgMain",t.realName=null!=t.realName?t.realName:"avgMain",e.setAttribute("id",null!=t.idName?t.idName:"avgMain"),e.setAttribute("class",null!=t.className?t.className:"avgCanvas"),y=null!=t.backgroundColor?t.backgroundColor:"#000",w=null!=t.defaultFont?t.defaultFont:'40px Arial,"Microsoft Yahei"',p=null!=t.defaultFontColor?t.defaultFontColor:"#FFF",e.setAttribute("name",t.realName?t.realName:"avgMain"),e.width=t.width,e.height=t.height,e.style.touchAction="none",v.body.insertBefore(e,v.body.lastChild),a=e,u=e.getContext("2d"),(r=v.createElement("canvas")).width=t.width,r.height=t.height,s=r.getContext("2d"),c=null!=t.volumeBGM?t.volumeBGM:.7,f=null!=t.volumeSE?t.volumeSE:.7,m=null!=t.volumeVoice?t.volumeVoice:.7,d=t.width,g=t.height,b=new Y;let n,i=a;i.addEventListener("mousemove",function(e){n=i.getBoundingClientRect(),A=(e.clientX-n.left)*(t.width/n.width),F=(e.clientY-n.top)*(t.height/n.height)}),function(){u.globalCompositeOperation="destination-over";let t,e=!1;requestAnimationFrame(function n(){u.beginPath(),u.clearRect(0,0,d,g);for(var i=x.length-1;i>=0;i--)if(x[i]){const n=x[i];if(n.mask&&!e?(e=n.mask,s.globalCompositeOperation="destination-over",t=u,u=s):"shade"==e?s.globalCompositeOperation="source-in":"mask"!=e||n.mask||(s.globalCompositeOperation="destination-atop"),"image"==n.type){if(u.globalAlpha=n.alpha,0!=n.rotate){u.save();let t=0,e=0;null==n.rotatePointX&&null==n.rotatePointY?(t=n.x,e=n.y):null==n.rotatePointX&&null==n.rotatePointY||(t=n.rotatePointX,e=n.rotatePointY),u.translate(t,e);let i=n.rotate*Math.PI/180;u.rotate(i),u.drawImage(n.img,n.sx,n.sy,n.swidth,n.sheight,n.x-t,n.y-e,n.width,n.height),u.restore();continue}u.drawImage(n.img,n.sx,n.sy,n.swidth,n.sheight,n.x,n.y,n.width,n.height)}else if("text"==n.type){if(u.globalAlpha=n.alpha,u.fillStyle=n.color,u.font=n.font,0!=n.rotate){u.save();let t=0,e=0;null==n.rotatePointX&&null==n.rotatePointY?(t=n.x,e=n.y):null==n.rotatePointX&&null==n.rotatePointY||(t=n.rotatePointX,e=n.rotatePointY),u.translate(t,e);let i=n.rotate*Math.PI/180;u.rotate(i),u.fillText(n.text,n.x-t,n.y-e),u.restore();continue}u.fillText(n.text,n.x,n.y)}e&&!n.mask&&(e=!1,(u=t).drawImage(r,0,0),s.clearRect(0,0,d,g))}u.globalAlpha=1,u.fillStyle=y,u.fillRect(0,0,d,g),u.closePath(),requestAnimationFrame(n)})}(),console.log("avg.Js 已完成初始化")}let a,r,u,s,h,c,f,m,d,g,y,w,p,v=t.document,x=(t.navigator,t.location,new Array),P=new Array,A=0,F=0;new(t.AudioContext||t.webkitAudioContext);P.remove=(t=>{for(const e in P)if(P.hasOwnProperty(e)){if(P[e]===t)return void P.splice(e,1)}});class Y{constructor(){this._queue=new Array,this.next()}add(t){this._queue.push(function(){return new Promise(e=>{t(e)})}),this._flag||this.next()}hasNext(){return this._queue.length>0}next(){const t=this;this._flag=!0,async function(){for(;t.hasNext();)await t._queue[0](),t._queue.splice(0,1);t._flag=!1}()}stopQueue(){cancelAnimationFrame(this._flag)}}let b;t.avg={};let C=t.avg;C.creaveWindow=l,C.loadImage=function(t){b.add(function(e){n(t,e)})},C.loadText=function(t){b.add(function(e){o(t,e)})},C.playBGM=function(t){b.add(function(e){!function(t,e){try{t.src?h?h.src=t.src:h=new Audio(t.src):(h&&h.pause(),h=t.audio),h.autoplay=!0,h.loop=!0,h.volume=c*(null==t.volume?1:t.volume),e(),4==h.readyState?h.play():h.oncanplay=function(){h.play()}}catch(t){console.log(t),e()}}(t,e)})},C.stopBGM=function(t){b.add(function(e){!function(t={time:0},e){if(!h)return void e();let n,i,o=h.volume;e(),requestAnimationFrame(function e(l){n||(n=l),0==t.time&&(t.time=1),(i=1-(l-n)/t.time)<0&&(i=0),h.volume=o*i,i>0&&requestAnimationFrame(e)})}(t,e)})},C.playSE=function(t){b.add(function(e){!function(t,e){try{let n;n=t.src?P.push(new Audio(t.src))-1:P.push(t.audio)-1,(n=P[n]).autoplay=!0,n.loop=!!t.loop,n.volume=f*(null==t.volume?1:t.volume),n.onended=function(){P.remove(n)},e(),4==n.readyState?n.play():n.oncanplay=function(){n.play()}}catch(t){console.log(t),e()}}(t,e)})},C.setLayer=function(t){b.add(function(e){!function(t,e){t.layer&&t.from?(x[t.layer]=t.from,t.from.layer=t.layer,e()):e()}(t,e)})},C.removeLayer=function(t){b.add(function(e){!function(t,e){if(!t.layer)return void e();const n=x[t.layer];x[t.layer]=null,t.fun&&t.fun(n),e()}(t,e)})},C.removeAllLayer=function(){b.add(function(t){!function(t){for(i in x)x[i]=null;t()}(t)})},C.move=function(t,e){b.add(function(n){!function(t,e=0,n){try{if(x[t.layer]){let i,o={},l=performance.now(),a=e,r={};for(let e in t)r[e]=x[t.layer][e],o[e]=x[t.layer][e],o[e]-=t[e],o[e]*=-1;if(0==e){for(let e in t)x[t.layer][e]=t[e];return void n()}o.layer=0;let u,s,h=t.layer,c=requestAnimationFrame(function t(){if(u<=0){for(let t in o)x[h][t]=o[t]+r[t];return cancelAnimationFrame(c),!0}i=performance.now(),(s=0==a?1:(i-l)/a)>1&&(s=1);for(let t in o)x[h][t]=s*o[t]+r[t];u=a-(i-l),s<1&&(c=requestAnimationFrame(t))});n()}}catch(t){console.log(t)}}(t,e,n)})},C.wait=function(t){b.add(function(e){!function(t,e){let n=performance.now();(t-=13.34)<0&&(t=0);let i,o=requestAnimationFrame(function l(){(i=performance.now()-n)>=t?e():o=requestAnimationFrame(l)})}(t,e)})},C.waitByFrame=function(t){b.add(function(e){!function(t,e){let n=t,i=requestAnimationFrame(function t(){--n<=0?e():i=requestAnimationFrame(t)})}(t,e)})},C.setColor=function(t,e){b.add(function(n){x[t].color=e,n()})},C.runFunction=function(t){b.add(function(e){!function(t,e){var n,i=!0;try{t()}catch(t){n=t,t.info&&"BREAK_BY_AVG"===t.info?(t.plies--,t.plies<=0&&(i=!0,console.log("runFunction Broke"))):(console.log(t),console.log("runFunction runError"))}finally{if(i)e();else if(n)throw n}}(t,e)})},C.break=function(t){!function(t=1){throw{plies:t,info:"BREAK_BY_AVG"}}(t)},C.getLayerClientRect=function(t){const e=x[t];return e?{x:e.x,y:e.y,width:e.width,height:e.height}:null},C.run=C.runFunction,C.getDOM=function(){return a},C.mouse={x:new function(){this.toString=function(){return A}},y:new function(){this.toString=function(){return F}}}}(window);